###############################################################################
# Cheapest Energy Windows - Battery Control Automation Template
#
# This automation triggers on CEW state changes and allows you to control
# your battery system based on detected charging/discharging windows.
#
# To use this automation:
# 1. This file will be automatically created during setup if you choose to
# 2. Or manually: Copy this content to Configuration â†’ Automations â†’ Create
# 3. Add your battery control actions in each sequence section
#
# Note: This template has no default actions - you must configure your
# battery control commands based on your specific battery system.
###############################################################################

alias: CEW - Battery Control (Auto-Managed - DO NOT EDIT OR DELETE)
description: Control your home battery based on Cheapest Energy Windows calculations
mode: queued
max: 10

trigger:
  - platform: state
    entity_id: switch.cew_automation_enabled
    to: 'off'
    id: automation_disabled
  - platform: state
    entity_id: sensor.cew_today
    to: charge
    from:
    - discharge
    - normal
    - 'off'
    id: charge_start
  - platform: state
    entity_id: sensor.cew_today
    to: discharge
    from:
    - charge
    - normal
    - 'off'
    id: discharge_start
  - platform: state
    entity_id: sensor.cew_today
    to: normal
    from:
    - charge
    - discharge
    - 'off'
    id: normal_start
  - platform: state
    entity_id: sensor.cew_today
    to: 'off'
    from:
    - charge
    - discharge
    - normal
    id: off_start
  - platform: time
    at: "00:00:10"  # 10 seconds after midnight to avoid races
    id: midnight_rotation

# Filter out transitions from 'unavailable' state (happens during config changes/reloads)
# But allow midnight rotation trigger
condition:
  - condition: or
    conditions:
      - condition: trigger
        id: midnight_rotation
      - condition: template
        value_template: '{{ trigger.from_state.state != ''unavailable'' }}'

action:
  - choose:
      #########################################################################
      # CHARGE State - Cheap energy window detected
      #########################################################################
      - conditions:
          - condition: trigger
            id: charge_start
        sequence:
          # Send notification if enabled
          - choose:
              - conditions:
                  - condition: state
                    entity_id: switch.cew_notifications_enabled
                    state: 'on'
                  - condition: state
                    entity_id: switch.cew_notify_charging
                    state: 'on'
                  - condition: or
                    conditions:
                      - condition: state
                        entity_id: switch.cew_quiet_hours_enabled
                        state: 'off'
                      - condition: template
                        value_template: >-
                          {% set now_time = now().strftime('%H:%M') %}
                          {% set quiet_start = states('time.cew_quiet_hours_start') %}
                          {% set quiet_end = states('time.cew_quiet_hours_end') %}
                          {{ now_time < quiet_start or now_time >= quiet_end }}
                sequence:
                  - service: notify.notify
                    data:
                      title: "ðŸ”‹ CEW: Charging Mode Started"
                      message: >-
                        Current price: â‚¬{{ state_attr('sensor.cew_today', 'current_price') | float(0) | round(5) }}/kWh

                        Avg cheap price: â‚¬{{ state_attr('sensor.cew_today', 'avg_cheap_price') | float(0) | round(5) }}/kWh

                        Charge power: {{ states('number.cew_charge_power') }}W

                        Profit: {{ state_attr('sensor.cew_today', 'charge_profit_pct') | float(0) | round(1) }}%
            default: []

          # Execute linked automation/script/scene if configured
          - choose:
              - conditions:
                  - condition: template
                    value_template: >-
                      {% set entity = states('text.cew_battery_charge_action') %}
                      {{ entity != 'not_configured' and entity != 'unknown' and entity != '' }}
                sequence:
                  - service: >
                      {% if states('text.cew_battery_charge_action').startswith('automation.') %}
                        automation.trigger
                      {% elif states('text.cew_battery_charge_action').startswith('script.') %}
                        script.turn_on
                      {% elif states('text.cew_battery_charge_action').startswith('scene.') %}
                        scene.turn_on
                      {% endif %}
                    target:
                      entity_id: "{{ states('text.cew_battery_charge_action') }}"
            default: []

      #########################################################################
      # DISCHARGE State - Expensive energy window detected
      #########################################################################
      - conditions:
          - condition: trigger
            id: discharge_start
        sequence:
          # Check buffer limits before discharge
          - choose:
              # Case 1: Buffer limiting enabled but energy sensor not configured
              - conditions:
                  - condition: state
                    entity_id: switch.cew_limit_discharge_to_buffer
                    state: 'on'
                  - condition: or
                    conditions:
                      - condition: state
                        entity_id: text.cew_battery_available_energy_sensor
                        state: 'not_configured'
                      - condition: state
                        entity_id: text.cew_battery_available_energy_sensor
                        state: ''
                sequence:
                  - condition: and
                    conditions:
                      - condition: state
                        entity_id: switch.cew_notifications_enabled
                        state: 'on'
                      - condition: or
                        conditions:
                          - condition: state
                            entity_id: switch.cew_quiet_hours_enabled
                            state: 'off'
                          - condition: template
                            value_template: >-
                              {% set now_time = now().strftime('%H:%M') %}
                              {% set quiet_start = states('time.cew_quiet_hours_start') %}
                              {% set quiet_end = states('time.cew_quiet_hours_end') %}
                              {{ now_time < quiet_start or now_time >= quiet_end }}
                  - service: notify.notify
                    data:
                      title: "âš ï¸ CEW: Buffer Limit Misconfigured"
                      message: >-
                        Discharge buffer limiting is enabled but battery energy sensor is not configured.

                        Please configure the battery available energy sensor in Settings or disable buffer limiting.
                  - stop: "Buffer limiting enabled but energy sensor not configured"

              # Case 2: Buffer limiting enabled but energy sensor unavailable/unknown
              - conditions:
                  - condition: state
                    entity_id: switch.cew_limit_discharge_to_buffer
                    state: 'on'
                  - condition: template
                    value_template: >-
                      {% set sensor = states('text.cew_battery_available_energy_sensor') %}
                      {% set current_energy = states(sensor) | float(-999) %}
                      {{ sensor not in ['not_configured', ''] and current_energy == -999 }}
                sequence:
                  - condition: and
                    conditions:
                      - condition: state
                        entity_id: switch.cew_notifications_enabled
                        state: 'on'
                      - condition: or
                        conditions:
                          - condition: state
                            entity_id: switch.cew_quiet_hours_enabled
                            state: 'off'
                          - condition: template
                            value_template: >-
                              {% set now_time = now().strftime('%H:%M') %}
                              {% set quiet_start = states('time.cew_quiet_hours_start') %}
                              {% set quiet_end = states('time.cew_quiet_hours_end') %}
                              {{ now_time < quiet_start or now_time >= quiet_end }}
                  - service: notify.notify
                    data:
                      title: "âš ï¸ CEW: Battery Sensor Unavailable"
                      message: >-
                        {% set sensor = states('text.cew_battery_available_energy_sensor') %}
                        Battery energy sensor ({{ sensor }}) is unavailable or returning invalid data.

                        Discharge blocked to protect battery reserve. Check your sensor configuration.
                  - stop: "Battery energy sensor unavailable"

              # Case 3: Buffer limiting enabled and energy at or below limit
              - conditions:
                  - condition: state
                    entity_id: switch.cew_limit_discharge_to_buffer
                    state: 'on'
                  - condition: template
                    value_template: >-
                      {% set sensor = states('text.cew_battery_available_energy_sensor') %}
                      {% set limit = states('number.cew_discharge_buffer_limit_kwh') | float(0) %}
                      {% set current_energy = states(sensor) | float(-1) %}
                      {{ sensor not in ['not_configured', ''] and current_energy >= 0 and current_energy <= limit }}
                sequence:
                  # Send notification if enabled
                  - condition: and
                    conditions:
                      - condition: state
                        entity_id: switch.cew_notifications_enabled
                        state: 'on'
                      - condition: or
                        conditions:
                          - condition: state
                            entity_id: switch.cew_quiet_hours_enabled
                            state: 'off'
                          - condition: template
                            value_template: >-
                              {% set now_time = now().strftime('%H:%M') %}
                              {% set quiet_start = states('time.cew_quiet_hours_start') %}
                              {% set quiet_end = states('time.cew_quiet_hours_end') %}
                              {{ now_time < quiet_start or now_time >= quiet_end }}
                  - service: notify.notify
                    data:
                      title: "ðŸ”‹ CEW: Discharge Blocked by Buffer Limit"
                      message: >-
                        {% set sensor = states('text.cew_battery_available_energy_sensor') %}
                        {% set limit = states('number.cew_discharge_buffer_limit_kwh') | float(0) %}
                        {% set current_energy = states(sensor) | float(0) %}
                        Battery energy ({{ current_energy }} kWh) is at or below discharge limit ({{ limit }} kWh).

                        Mode set to normal to protect battery reserve.
                  - stop: "Energy below discharge buffer limit"

          # Send notification if enabled
          - choose:
              - conditions:
                  - condition: state
                    entity_id: switch.cew_notifications_enabled
                    state: 'on'
                  - condition: state
                    entity_id: switch.cew_notify_discharge
                    state: 'on'
                  - condition: or
                    conditions:
                      - condition: state
                        entity_id: switch.cew_quiet_hours_enabled
                        state: 'off'
                      - condition: template
                        value_template: >-
                          {% set now_time = now().strftime('%H:%M') %}
                          {% set quiet_start = states('time.cew_quiet_hours_start') %}
                          {% set quiet_end = states('time.cew_quiet_hours_end') %}
                          {{ now_time < quiet_start or now_time >= quiet_end }}
                sequence:
                  - service: notify.notify
                    data:
                      title: "âš¡ CEW: Discharge Mode Started"
                      message: >-
                        Current price: â‚¬{{ state_attr('sensor.cew_today', 'current_price') | float(0) | round(5) }}/kWh

                        Avg expensive price: â‚¬{{ state_attr('sensor.cew_today', 'avg_expensive_price') | float(0) | round(5) }}/kWh

                        Discharge power: {{ states('number.cew_discharge_power') }}W

                        Profit: {{ state_attr('sensor.cew_today', 'charge_profit_pct') | float(0) | round(1) }}%
            default: []

          # Execute linked automation/script/scene if configured
          - choose:
              - conditions:
                  - condition: template
                    value_template: >-
                      {% set entity = states('text.cew_battery_discharge_action') %}
                      {{ entity != 'not_configured' and entity != 'unknown' and entity != '' }}
                sequence:
                  - service: >
                      {% if states('text.cew_battery_discharge_action').startswith('automation.') %}
                        automation.trigger
                      {% elif states('text.cew_battery_discharge_action').startswith('script.') %}
                        script.turn_on
                      {% elif states('text.cew_battery_discharge_action').startswith('scene.') %}
                        scene.turn_on
                      {% endif %}
                    target:
                      entity_id: "{{ states('text.cew_battery_discharge_action') }}"
            default: []

      #########################################################################
      # NORMAL State - No charge or discharge window active
      #########################################################################
      - conditions:
          - condition: trigger
            id: normal_start
        sequence:
          # Send notification if enabled
          - choose:
              - conditions:
                  - condition: state
                    entity_id: switch.cew_notifications_enabled
                    state: 'on'
                  - condition: state
                    entity_id: switch.cew_notify_normal
                    state: 'on'
                  - condition: or
                    conditions:
                      - condition: state
                        entity_id: switch.cew_quiet_hours_enabled
                        state: 'off'
                      - condition: template
                        value_template: >-
                          {% set now_time = now().strftime('%H:%M') %}
                          {% set quiet_start = states('time.cew_quiet_hours_start') %}
                          {% set quiet_end = states('time.cew_quiet_hours_end') %}
                          {{ now_time < quiet_start or now_time >= quiet_end }}
                sequence:
                  - service: notify.notify
                    data:
                      title: "ðŸ’¤ CEW: Normal Mode Started"
                      message: >-
                        Current price: â‚¬{{ state_attr('sensor.cew_today', 'current_price') | float(0) | round(5) }}/kWh

                        Profit: {{ state_attr('sensor.cew_today', 'charge_profit_pct') | float(0) | round(1) }}%
            default: []

          # Execute linked automation/script/scene if configured
          - choose:
              - conditions:
                  - condition: template
                    value_template: >-
                      {% set entity = states('text.cew_battery_normal_action') %}
                      {{ entity != 'not_configured' and entity != 'unknown' and entity != '' }}
                sequence:
                  - service: >
                      {% if states('text.cew_battery_normal_action').startswith('automation.') %}
                        automation.trigger
                      {% elif states('text.cew_battery_normal_action').startswith('script.') %}
                        script.turn_on
                      {% elif states('text.cew_battery_normal_action').startswith('scene.') %}
                        scene.turn_on
                      {% endif %}
                    target:
                      entity_id: "{{ states('text.cew_battery_normal_action') }}"
            default: []

      #########################################################################
      # OFF State - Battery operations suspended
      #########################################################################
      - conditions:
          - condition: trigger
            id: off_start
        sequence:
          # Send notification if enabled
          - choose:
              - conditions:
                  - condition: state
                    entity_id: switch.cew_notifications_enabled
                    state: 'on'
                  - condition: state
                    entity_id: switch.cew_notify_off
                    state: 'on'
                  - condition: or
                    conditions:
                      - condition: state
                        entity_id: switch.cew_quiet_hours_enabled
                        state: 'off'
                      - condition: template
                        value_template: >-
                          {% set now_time = now().strftime('%H:%M') %}
                          {% set quiet_start = states('time.cew_quiet_hours_start') %}
                          {% set quiet_end = states('time.cew_quiet_hours_end') %}
                          {{ now_time < quiet_start or now_time >= quiet_end }}
                sequence:
                  - service: notify.notify
                    data:
                      title: "ðŸ”Œ CEW: Battery Off"
                      message: >-
                        Battery operations suspended.
            default: []

          # Execute linked automation/script/scene if configured
          - choose:
              - conditions:
                  - condition: template
                    value_template: >-
                      {% set entity = states('text.cew_battery_off_action') %}
                      {{ entity != 'not_configured' and entity != 'unknown' and entity != '' }}
                sequence:
                  - service: >
                      {% if states('text.cew_battery_off_action').startswith('automation.') %}
                        automation.trigger
                      {% elif states('text.cew_battery_off_action').startswith('script.') %}
                        script.turn_on
                      {% elif states('text.cew_battery_off_action').startswith('scene.') %}
                        scene.turn_on
                      {% endif %}
                    target:
                      entity_id: "{{ states('text.cew_battery_off_action') }}"
            default: []

      #########################################################################
      # AUTOMATION DISABLED - User turned off automation switch
      #########################################################################
      - conditions:
          - condition: trigger
            id: automation_disabled
        sequence:
          # Send notification if enabled
          - choose:
              - conditions:
                  - condition: state
                    entity_id: switch.cew_notifications_enabled
                    state: 'on'
                  - condition: state
                    entity_id: switch.cew_notify_automation_disabled
                    state: 'on'
                  - condition: or
                    conditions:
                      - condition: state
                        entity_id: switch.cew_quiet_hours_enabled
                        state: 'off'
                      - condition: template
                        value_template: >-
                          {% set now_time = now().strftime('%H:%M') %}
                          {% set quiet_start = states('time.cew_quiet_hours_start') %}
                          {% set quiet_end = states('time.cew_quiet_hours_end') %}
                          {{ now_time < quiet_start or now_time >= quiet_end }}
                sequence:
                  - service: notify.notify
                    data:
                      title: "â›” CEW: Automation Disabled"
                      message: >-
                        CEW automation has been turned off.
            default: []

      #########################################################################
      # MIDNIGHT ROTATION - Rotate tomorrow's settings to today at midnight
      #########################################################################
      - conditions:
          - condition: trigger
            id: midnight_rotation
          - condition: state
            entity_id: switch.cew_tomorrow_settings_enabled
            state: 'on'
        sequence:
          # 1. Call the rotation service
          - service: cheapest_energy_windows.rotate_tomorrow_settings
            data: {}

          # 2. Small delay for settings to propagate
          - delay:
              seconds: 2

          # 3. Force coordinator refresh
          - service: homeassistant.update_entity
            target:
              entity_id: sensor.cew_today

          # 4. Disable tomorrow settings switch
          - service: switch.turn_off
            target:
              entity_id: switch.cew_tomorrow_settings_enabled

          # 5. Send notification if enabled
          - choose:
              - conditions:
                  - condition: state
                    entity_id: switch.cew_notifications_enabled
                    state: 'on'
                  - condition: state
                    entity_id: switch.cew_midnight_rotation_notifications
                    state: 'on'
                  # Check quiet hours
                  - condition: or
                    conditions:
                      - condition: state
                        entity_id: switch.cew_quiet_hours_enabled
                        state: 'off'
                      - condition: template
                        value_template: >-
                          {% set now = now().strftime('%H:%M') %}
                          {% set quiet_start = states('time.cew_quiet_hours_start') %}
                          {% set quiet_end = states('time.cew_quiet_hours_end') %}
                          {% if quiet_start < quiet_end %}
                            {{ now < quiet_start or now >= quiet_end }}
                          {% else %}
                            {{ now < quiet_start and now >= quiet_end }}
                          {% endif %}
                sequence:
                  - service: notify.notify
                    data:
                      title: "ðŸ”„ CEW: Settings Rotated"
                      message: "Tomorrow's settings have been applied to today"
            default: []

    default: []

###############################################################################
# CUSTOMIZATION GUIDE:
#
# 1. Add quiet hours condition (optional):
#    Add this to the top-level 'condition:' section:
#    - condition: template
#      after: "07:00:00"
#      before: "22:00:00"
#
# 2. Add battery energy check (if you have battery sensors):
#    Add this to specific sequences (e.g., charge_start):
#    - condition: numeric_state
#      entity_id: sensor.your_battery_available_energy
#      below: 9.5  # Don't charge if battery is near full (in kWh)
#
# 3. Add notifications (optional):
#    - service: notify.mobile_app_your_phone
#      data:
#        title: "Battery Status"
#        message: "Current price: â‚¬{{ state_attr('sensor.cew_today', 'current_price') | round(5) }}/kWh"
#
# 4. Connect to your battery system:
#    Replace the example actions with service calls specific to your battery:
#    - Zendure: Use zendure_solarflow integration services
#    - Tesla Powerwall: Use tesla_custom integration services
#    - SolarEdge: Use solaredge_modbus integration services
#    - Generic MQTT: Use mqtt.publish service
#
# 5. Use CEW sensor attributes in your actions:
#    - Current price: {{ state_attr('sensor.cew_today', 'current_price') }}
#    - Charge power: {{ states('number.cew_charge_power') }}
#    - Discharge power: {{ states('number.cew_discharge_power') }}
#    - Profit: {{ state_attr('sensor.cew_today', 'charge_profit_pct') }}
#    - Window times: {{ state_attr('sensor.cew_today', 'cheapest_times') }}
#
###############################################################################
